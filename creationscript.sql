DROP DATABASE IF EXISTS lifttracker;
CREATE DATABASE lifttracker;

DROP USER 'lifttrackerwebuser'@'localhost';
CREATE USER 'lifttrackerwebuser'@'localhost' IDENTIFIED BY 'lifttrackerwebuser1234';
GRANT SELECT, UPDATE, INSERT, DELETE ON lifttracker.* TO 'lifttrackerwebuser'@'localhost';

USE lifttracker;

CREATE TABLE enduser
(
	id INT NOT NULL UNIQUE AUTO_INCREMENT,
	username VARCHAR(32),
	password VARCHAR(40) NOT NULL,
	vital tinyint(1) NOT NULL DEFAULT 0,
  CONSTRAINT ENDUSER_PK PRIMARY KEY (username)
) ENGINE=InnoDB;

INSERT INTO enduser (id, username, password, vital) VALUES
  (1, 'root', Sha1('root'), 1),
  (2, 'wdgarey', Sha1('pimp99'), 0);

CREATE TABLE role
(
  id INT NOT NULL UNIQUE AUTO_INCREMENT,
  name VARCHAR(32) NOT NULL,
  vital tinyint(1) NOT NULL DEFAULT 0,
  CONSTRAINT ROLE_PK PRIMARY KEY (name)
) ENGINE=InnoDB;

INSERT INTO role (id, name, vital) VALUES (1, 'Admin', 1);

CREATE TABLE func
(
  id INT NOT NULL UNIQUE AUTO_INCREMENT,
  name VARCHAR(32) NOT NULL,
  vital tinyint(1) NOT NULL DEFAULT 0,
  CONSTRAINT FUNCTION_PK PRIMARY KEY (name)
) ENGINE=InnoDB;

INSERT INTO func (id, name, vital) VALUES
  (1, 'enduseradd', 1),
  (2, 'enduseredit', 1),
  (3, 'enduserview', 1),
  (4, 'enduserdelete', 1),
	(5, 'manageendusers', 1),
	(6, 'roleadd', 1),
	(7, 'roleedit', 1),
	(8, 'roleview', 1),
	(9, 'roledelete', 1),
	(10, 'manageroles', 1);

CREATE TRIGGER GIVFUNCTOADMIN_TRIG
AFTER INSERT ON func
	FOR EACH ROW
		INSERT INTO rolefunc (roleid, funcid)
		VALUES(1, NEW.id);

CREATE TABLE enduserrole
(
  enduserid INT,
  roleid INT,
  CONSTRAINT ENDUSERROLE_PK PRIMARY KEY (enduserid, roleid),
  CONSTRAINT ENDUSERROLE_ROLE_FK FOREIGN KEY(roleid) REFERENCES role(id) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT ENDUSERROLE_USER_FK FOREIGN KEY(enduserid) REFERENCES enduser(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

INSERT INTO enduserrole (enduserid, roleid) VALUES
	(1, 1),
	(2, 1);

CREATE TABLE rolefunc
(
  roleid INT,
  funcid INT,
  CONSTRAINT ROLEFUNCTION_PK PRIMARY KEY (roleid, funcid),
  CONSTRAINT ROLEFUNCTION_FUNCTION_FK FOREIGN KEY (funcid) REFERENCES func(id) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT ROLEFUNCTION_ROLE_FK FOREIGN KEY (roleid) REFERENCES role (id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

INSERT INTO rolefunc (roleid, funcid) VALUES
	(1, 1),
	(1, 2),
	(1, 3),
	(1, 4),
	(1, 5),
	(1, 6),
	(1, 7),
	(1, 8),
	(1, 9),
	(1, 10);

CREATE TABLE profile
(
  enduserid INT,
	firstname VARCHAR(40) DEFAULT '',
	lastname VARCHAR(40) DEFAULT '',
	height NUMERIC(5, 2),
	weight NUMERIC(5, 2),
  CONSTRAINT PROFILE_PK PRIMARY KEY (enduserid),
  CONSTRAINT PROFILE_USER_FK FOREIGN KEY (enduserid) REFERENCES enduser(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE liftgroup
(
	id INT NOT NULL UNIQUE AUTO_INCREMENT,
  enduserid INT,
	name VARCHAR(32),
	autoupdate tinyint(1) DEFAULT FALSE,
	autoupdatedate DATE,
	autoupdateincrement NUMERIC(4, 2) DEFAULT 0.0,
  CONSTRAINT LIFTGROUP_PK PRIMARY KEY(enduserid, name),
  CONSTRAINT LIFTGROUP_USER_FK FOREIGN KEY(enduserid) REFERENCES enduser(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE lift
(
	id INT NOT NULL UNIQUE AUTO_INCREMENT,
	liftgroupid INT,
	name VARCHAR(32),	
	trainingweight NUMERIC(6, 2) NOT NULL DEFAULT 0.0,
	CONSTRAINT LIFT_PK PRIMARY KEY(liftgroupid, name),
	CONSTRAINT LIFT_LIFTGROUP_FK FOREIGN KEY(liftgroupid) REFERENCES liftgroup(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE liftrecord
(
	id INT AUTO_INCREMENT,
	liftid INT NOT NULL,
	day DATE NOT NULL,
	weight NUMERIC(6, 2) NOT NULL DEFAULT 0.0,
	reps INT NOT NULL DEFAULT 0,
	CONSTRAINT LIFTRECORD_PK PRIMARY KEY (id),
	CONSTRAINT LIFTRECORD_LIFT_FK FOREIGN KEY(liftid) REFERENCES lift(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE scheme
(
	id INT NOT NULL UNIQUE AUTO_INCREMENT,
  enduserid INT,
	name VARCHAR(32),	
  CONSTRAINT SCHEME_PK PRIMARY KEY(enduserid, name),
  CONSTRAINT SCHEME_USER_FK FOREIGN KEY(enduserid) REFERENCES enduser(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE week
(
	id INT NOT NULL UNIQUE AUTO_INCREMENT,
	schemeid INT,
	name VARCHAR(32),	
	CONSTRAINT WEEK_PK PRIMARY KEY(schemeid, name),
	CONSTRAINT WEEK_SCHEME_FK FOREIGN KEY(schemeid) REFERENCES scheme(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE day
(
	id INT NOT NULL UNIQUE AUTO_INCREMENT,
	weekid INT,
	name VARCHAR(32),
	CONSTRAINT DAY_PK PRIMARY KEY(weekid, name),
	CONSTRAINT DAY_WEEK_FK FOREIGN KEY(weekid) REFERENCES week(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE workout
(
	id INT NOT NULL UNIQUE AUTO_INCREMENT,
	dayid INT,
	name VARCHAR(32),
	CONSTRAINT WORKOUT_PK PRIMARY KEY(dayid, name),
	CONSTRAINT WORKOUT_DAY_FK FOREIGN KEY(dayid) REFERENCES day(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE exercise
(
	id INT NOT NULL UNIQUE AUTO_INCREMENT,
	workoutid INT,
	name VARCHAR(32),
	liftid INT NOT NULL,
	CONSTRAINT EXERCISE_PK PRIMARY KEY(workoutid, name),
	CONSTRAINT EXERCISE_LIFT_FK FOREIGN KEY(liftid) REFERENCES lift(id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT EXERCISE_WORKOUT_FK FOREIGN KEY(workoutid) REFERENCES workout(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE sset
(
	id INT NOT NULL UNIQUE AUTO_INCREMENT,
	exerciseid INT,
	name VARCHAR(32),
	percent NUMERIC(2, 2) NOT NULL,
	reps INT NOT NULL,
	CONSTRAINT SSET_PK PRIMARY KEY(exerciseid, name),
	CONSTRAINT SSET_EXERCISE_FK FOREIGN KEY(exerciseid) REFERENCES exercise(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;
